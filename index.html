import React, { useState, useEffect } from 'react';
import { MapContainer, TileLayer, Marker, Popup, Polyline, useMap } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';

// ხატულების გასწორება Leaflet-ისთვის
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png',
  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
});

// 1. თარგმანების ობიექტი
const translations = {
  ka: { title: "თბილისის ტრანსპორტი", search: "სად მიდიხართ?", start: "თქვენი მდებარეობა", go: "მიყვანე აქ", min: "წთ", routes: "მარშრუტები" },
  en: { title: "Tbilisi Transport", search: "Where to?", start: "Your Location", go: "Get Directions", min: "min", routes: "Routes" },
  ru: { title: "Тбилисский Транспорт", search: "Куда едем?", start: "Ваше местоположение", go: "Маршрут", min: "мин", routes: "Маршруты" }
};

// 2. სატესტო მონაცემები (ლოკაციებით)
const initialBuses = [
  { id: 1, number: '37', from: 'Samgori', to: 'Dighomi', coords: [41.685, 44.825], time: 13, color: '#3b82f6' },
  { id: 2, number: '55', from: 'Varketili', to: 'Delisi', coords: [41.725, 44.755], time: 8, color: '#10b981' }
];

const App = () => {
  const [lang, setLang] = useState('ka');
  const [userLoc] = useState([41.7151, 44.7870]); // თბილისის ცენტრი
  const [targetLoc, setTargetLoc] = useState(null);
  const [buses, setBuses] = useState(initialBuses);
  const t = translations[lang];

  // რეალური დროის იმიტაცია - დროის კლება
  useEffect(() => {
    const timer = setInterval(() => {
      setBuses(prev => prev.map(b => ({ ...b, time: b.time > 1 ? b.time - 1 : 15 })));
    }, 10000);
    return () => clearInterval(timer);
  }, []);

  const handleRouteClick = (coords) => {
    setTargetLoc(coords);
  };

  return (
    <div style={styles.container}>
      {/* Header */}
      <div style={styles.header}>
        <div style={styles.langBar}>
          {['ka', 'en', 'ru'].map(l => (
            <button key={l} onClick={() => setLang(l)} style={lang === l ? styles.activeLang : styles.langBtn}>
              {l.toUpperCase()}
            </button>
          ))}
        </div>
        <h2 style={styles.title}>{t.title}</h2>
      </div>

      {/* Map Section */}
      <div style={styles.mapWrapper}>
        <MapContainer center={userLoc} zoom={13} style={{ height: '100%', width: '100%' }}>
          <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
          <Marker position={userLoc}><Popup>{t.start}</Popup></Marker>
          
          {targetLoc && (
            <>
              <Marker position={targetLoc}><Popup>Destination</Popup></Marker>
              <Polyline positions={[userLoc, targetLoc]} color="blue" dashArray="10, 10" />
            </>
          )}
        </MapContainer>
      </div>

      {/* Routes List */}
      <div style={styles.listSection}>
        <h3>{t.routes}</h3>
        {buses.map(bus => (
          <div key={bus.id} style={styles.card} onClick={() => handleRouteClick(bus.coords)}>
            <div style={{ ...styles.busCircle, backgroundColor: bus.color }}>{bus.number}</div>
            <div style={styles.busInfo}>
              <div style={styles.busName}>{bus.from} - {bus.to}</div>
              <div style={styles.busTime}>~{bus.time} {t.min}</div>
            </div>
            <button style={styles.goBtn}>{t.go}</button>
          </div>
        ))}
      </div>
    </div>
  );
};

// 3. სტილები (Inline-CSS მაქსიმალური სიმარტივისთვის)
const styles = {
  container: { fontFamily: 'Segoe UI, sans-serif', backgroundColor: '#f0f2f5', height: '100vh', display: 'flex', flexDirection: 'column' },
  header: { padding: '20px', background: '#fff', borderBottom: '1px solid #ddd' },
  langBar: { display: 'flex', gap: '10px', marginBottom: '10px' },
  langBtn: { border: 'none', background: '#eee', padding: '5px 10px', borderRadius: '5px', cursor: 'pointer' },
  activeLang: { border: 'none', background: '#3b82f6', color: '#fff', padding: '5px 10px', borderRadius: '5px' },
  title: { margin: 0, fontSize: '20px' },
  mapWrapper: { height: '300px', width: '100%', position: 'relative' },
  listSection: { padding: '20px', overflowY: 'auto', flex: 1 },
  card: { display: 'flex', alignItems: 'center', background: '#fff', padding: '15px', borderRadius: '15px', marginBottom: '10px', boxShadow: '0 2px 5px rgba(0,0,0,0.1)', cursor: 'pointer' },
  busCircle: { width: '45px', height: '45px', borderRadius: '50%', color: '#fff', display: 'flex', justifyContent: 'center', alignItems: 'center', fontWeight: 'bold', marginRight: '15px' },
  busInfo: { flex: 1 },
  busName: { fontWeight: '600' },
  busTime: { color: '#666', fontSize: '14px' },
  goBtn: { background: '#f0f7ff', color: '#3b82f6', border: 'none', padding: '8px 12px', borderRadius: '8px', fontWeight: 'bold' }
};

export default App;

